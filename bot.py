import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CallbackQueryHandler, CommandHandler, MessageHandler, filters, ContextTypes
from datetime import datetime, timedelta
from dotenv import load_dotenv

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ© Ù…Ù† Ù…Ù„Ù .env
load_dotenv()

# Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©
TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

# Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
reminders = {}
user_data = {}

# Ø¯Ø§Ù„Ø© Ù„Ø¨Ø¯Ø¡ Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ±
async def start_reminder(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.message.chat_id
    user_data[chat_id] = {}

    # Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®
    keyboard = []
    today = datetime.now()
    for i in range(7):  # Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
        day = today + timedelta(days=i)
        keyboard.append([InlineKeyboardButton(day.strftime("%Y-%m-%d"), callback_data=f"date:{day.strftime('%Y-%m-%d')}")])

    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text("Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®:", reply_markup=reply_markup)

# Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    chat_id = query.message.chat_id

    if query.data.startswith("date:"):
        # ØªØ®Ø²ÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø®ØªØ§Ø±
        selected_date = query.data.split(":")[1]
        user_data[chat_id]['date'] = selected_date

        # Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª
        keyboard = []
        for hour in range(9, 21):  # Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø¨ÙŠÙ† 9 ØµØ¨Ø§Ø­Ù‹Ø§ Ùˆ9 Ù…Ø³Ø§Ø¡Ù‹
            keyboard.append([InlineKeyboardButton(f"{hour}:00", callback_data=f"time:{hour}:00")])

        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ‚Øª:", reply_markup=reply_markup)

    elif query.data.startswith("time:"):
        # ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø®ØªØ§Ø±
        selected_time = query.data.split(":")[1]
        user_data[chat_id]['time'] = selected_time

        # Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ø§Ù„ØªØ°ÙƒÙŠØ±
        await query.edit_message_text("Ø§Ù„Ø¢Ù†ØŒ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ÙˆØµÙ Ø§Ù„ØªØ°ÙƒÙŠØ± (Ù…Ø«Ù„: Ù…ÙˆØ¹Ø¯ Ù…Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¨)")

    elif query.data == "add_note":
        # Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©
        await query.edit_message_text("Ø£Ø±Ø³Ù„ Ù„ÙŠ Ø§Ù„Ù†Øµ Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ ÙÙŠ Ø­ÙØ¸Ù‡ ÙƒÙ…Ù„Ø§Ø­Ø¸Ø©.")
        user_data[chat_id] = {"adding_note": True}

    elif query.data == "show_notes":
        # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        notes = user_data.get(chat_id, {}).get("notes", [])
        if notes:
            await query.edit_message_text(f"Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©: {', '.join(notes)}")
        else:
            await query.edit_message_text("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.")
        await ask_for_more(update, context)

    elif query.data == "show_reminders":
        # Ø¹Ø±Ø¶ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if chat_id in reminders:
            reminder = reminders[chat_id]
            await query.edit_message_text(f"Ø§Ù„ØªØ°ÙƒÙŠØ±: {reminder['description']} ÙÙŠ {reminder['time']}")
        else:
            await query.edit_message_text("Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ°ÙƒÙŠØ±Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.")
        await ask_for_more(update, context)

# Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
async def text_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.message.chat_id
    text = update.message.text

    if chat_id in user_data and user_data[chat_id].get("adding_note"):
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        notes = user_data[chat_id].get("notes", [])
        notes.append(text)
        user_data[chat_id]["notes"] = notes

        # ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await update.message.reply_text(f"ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©: {text}")
        user_data[chat_id]["adding_note"] = False

        # Ø³Ø¤Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø´ÙŠØ¡ Ø¢Ø®Ø±
        await ask_for_more(update, context)

# Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰
async def ask_for_more(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©", callback_data="add_note")],
        [InlineKeyboardButton("Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ± Ø¬Ø¯ÙŠØ¯", callback_data="add_reminder")]
    ]

    chat_id = update.message.chat_id if update.message else update.callback_query.message.chat_id

    # Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª
    if 'notes' in user_data.get(chat_id, {}):
        keyboard.insert(1, [InlineKeyboardButton("Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©", callback_data="show_notes")])
    if chat_id in reminders:
        keyboard.append([InlineKeyboardButton("Ø¹Ø±Ø¶ Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©", callback_data="show_reminders")])

    reply_markup = InlineKeyboardMarkup(keyboard)
    await context.bot.send_message(chat_id, "Ù‡Ù„ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø´ÙŠØ¡ Ø¢Ø®Ø±ØŸ", reply_markup=reply_markup)

# Ø¯Ø§Ù„Ø© Ù„Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ø´Ø§Øª
async def welcome_user(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.message.chat_id

    # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡ÙŠ Ø±Ø³Ø§Ù„Ø© ØªØ±Ø­ÙŠØ¨ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    if chat_id not in user_data or user_data[chat_id].get('last_message', '') != 'welcome':
        welcome_message = f"Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ {update.message.from_user.first_name} ÙÙŠ Ø¨ÙˆØª Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª! ğŸ‰\n\n" \
                          "Ø³Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø¥Ø¶Ø§ÙØ© ØªØ°ÙƒÙŠØ± Ø£Ùˆ Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©.\n"
        await update.message.reply_text(welcome_message)

        # ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ©
        user_data[chat_id] = {'last_message': 'welcome'}

        # Ø¹Ø±Ø¶ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        await ask_for_more(update, context)

# Ø¯Ø§Ù„Ø© ØªØ¨Ø¯Ø£ Ø§Ù„Ø¨ÙˆØª ÙˆØªÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
def start_bot():
    try:
        app = ApplicationBuilder().token(TOKEN).build()

        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙˆØ¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø©
        app.add_handler(CommandHandler('start', welcome_user))
        app.add_handler(CallbackQueryHandler(button_handler))
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_handler))

        print("Bot is running...")
        app.run_polling(drop_pending_updates=True)  # Ø§Ø³ØªØ®Ø¯Ø§Ù… polling Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ¹Ø§Ø±Ø¶

    except Exception as e:
        print(f"Error starting the bot: {e}")

if __name__ == "__main__":
    start_bot()
